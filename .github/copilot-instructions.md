# GothicMultiplayer AI Guide
- **Project layout**: `gmp-client/gothic2a` builds the injected client DLL (`ClientMain`) that patches the Gothic II process via `HooksManager` and `Patch`; `gmp-server` hosts the dedicated server core around `GameServer`; `shared/` and `common/` expose cross-cutting math, event, and zNet protocol headers.
- **Build workflow**: Use `xmake f -m releasedbg -p windows -a x86` (Gothic hooks are 32-bit) then `xmake build ClientMain`/`ServerApp`; plain `xmake` builds everything; pass `--discord_app_id=` or `--master_server_endpoint=` via `xmake f` when needed.
- **Editor tasks**: VS Code tasks `Build ClientMain (xmake)` and `Build GMP Launcher` mirror the usual commands; prefer them when compiling in this workspace.
- **Install step**: Run `xmake install -o "C:\Program Files (x86)\Gothic II"` to copy DLLs and data via the custom `install_to_system_dir` helper (also deploys resources/Discord SDK when configured).
- **Version stamping**: `version.h.in` becomes `build/config/version.h` during configure; include `version.h` only from targets that already depend on the generated config directory.
- **Client hooks**: Engine callbacks must be registered through `HooksManager::AddHook` instead of new inline patches; respect the critical-section guarded maps and remember to call `RemoveHook` during teardown to avoid dangling function pointers.
- **Menu system**: New UI flow lives under `gmp-client/gothic2a/src/menu/`; states derive from `menu::states::MenuState`, share data via `MenuContext`, and are orchestrated by `MenuStateMachine` (see `CMainMenu::InitializeStateMachine`).
- **Client config**: Persist user settings with `Config::Instance()` which reads/writes `GMP_Config.toml`; window/console positions are tracked via SDL event watchers, so reuse `SetWindowPosition`/`SetConsolePosition` helpers.
- **Client networking**: `gmp::client::GameClient` wraps RakNet via the dynamically loaded `znet_client` (call `LoadNetworkLibrary()` once in `DllMain` before using); packets are parsed with `bitsery`, so keep handler registration in `InitPacketHandlers` in sync with `Net::PacketID` values in `common/znet/net_enums.h`.
- **Server runtime**: `gmp-server/lib/game_server.cpp` spins the main loop, loads `znet_server` through `dylib`, runs a 10 ms tick pumping `PlayerManager`, ban lists, and HTTP status (`HTTPServer` serves `world.wbm` on port+1).
- **Server config & identity**: Startup pulls settings from `resources/config.toml` into `Config`; Ed25519 keys derive from the `server_identity_seed` and are cached as binary vectors.
- **Lua scripting**: `Script` (sol2) loads files from `gmp-server/resources/scripts`; events defined in `server_events.h` are registered in `GameServer` and exposed to Lua via `Lua/event_bind.h`—add new hooks there instead of scripting ad-hoc singletons.
- **Networking protocol**: Shared packet layouts and enums live in `common/znet/` and `gmp-client/client-net/include`; any protocol change must update both sides and adjust matching `SerializeAndSend`/`GameClient` handlers.
- **Shared utilities**: Use `shared/toml_wrapper` for TOML IO and `shared/math.cpp` helpers for Gothic vector math; avoid duplicating filesystem or serialization helpers outside these modules.
- **Launcher**: `gmp-client/gothic2a/launcher` builds `GMPLauncher`, a thin wrapper that prepares Gothic, patches registry keys, and logs with `spdlog`; keep it console-friendly and reuse config lookups instead of raw Win32 reads.
- **Testing**: `xmake test` drives registered gtest binaries; individual targets such as `gmp-server/test/ban_list_test.cpp` or `tests/ConnectionTest` default to off—build with `xmake build ConnectionTest` then `xmake run ConnectionTest` when needed.
- **Logging & diagnostics**: Prefer `SPDLOG_*` macros already configured in both client and server; server logging sinks respect `log_to_stdout`/`log_file`, and the client keeps a rolling `GMP_Log.txt` plus optional external console.
- **Third-party loading**: Network backends come from `thirdparty/RakNet` via `zNetInterface` and are loaded with `dylib`; do not link RakNet symbols directly—extend the exported interface instead.
- **Gotchas**: Gothic addresses in `HooksManager::InitAllPatches` and `CallPatch` are brittle—validate against the 2.6 executable before changing—and ensure menu or hook teardown removes render callbacks to stop hard crashes on shutdown.
- **Coding style**: Default to Google's C++ style guide—brace placement, naming, and formatting all follow that convention; run clang-format with the repo config when touching older files to avoid churn.
- **Language level**: Targets build as C++20 (`set_languages("c++20")` in `xmake.lua`); prefer modern features (e.g., `std::span`, `std::optional`, `constexpr`) but stay compatible with MSVC 2022 and xmake's toolchain.
